<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Eye Tracking Focus Timer</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    video, canvas { position: absolute; left: 0; top: 0; }
    #status {
      position: absolute; top: 10px; left: 10px; 
      color: green; font-size: 24px; font-weight: bold; 
      background: rgba(255,255,255,0.7); padding: 5px 10px;
      border-radius: 8px;
    }
    #log {
      position: absolute; top: 520px; left: 10px;
      width: 640px; height: 200px; overflow-y: auto;
      background: #f0f0f0; padding: 10px; border-radius: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline width="640" height="480"></video>
  <canvas id="canvas" width="640" height="480"></canvas>
  <div id="status">Loading...</div>
  <div id="log"><b>Focus sessions (ms):</b><br></div>

<script>
  const videoElement = document.getElementById('video');
  const canvasElement = document.getElementById('canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const statusText = document.getElementById('status');
  const logDiv = document.getElementById('log');

  // ดัชนี landmark ตาซ้ายและขวาจาก MediaPipe FaceMesh
  const LEFT_EYE_INDICES = [33, 160, 158, 133, 153, 144];
  const RIGHT_EYE_INDICES = [362, 385, 387, 263, 373, 380];

  // ฟังก์ชันคำนวณระยะ Euclidean
  function euclideanDistance(p1, p2) {
    return Math.hypot(p1.x - p2.x, p1.y - p2.y);
  }

  // ฟังก์ชันคำนวณ EAR
  function calculateEAR(eye) {
    const A = euclideanDistance(eye[1], eye[5]);
    const B = euclideanDistance(eye[2], eye[4]);
    const C = euclideanDistance(eye[0], eye[3]);
    return (A + B) / (2.0 * C);
  }

  // Fixation detection params
  const gazeHistory = [];
  const MAX_HISTORY = 10;
  const FIXATION_VARIANCE_THRESHOLD = 0.0002; // ปรับให้เข้ากับการทดสอบ
  const FIXATION_TIME_THRESHOLD_MS = 300;

  let fixationStartTime = null;
  let isFixating = false;
  let focusSessions = [];
  let accumulatedFocusTime = 0;

  function updateGazePosition(newPos) {
    gazeHistory.push(newPos);
    if (gazeHistory.length > MAX_HISTORY) gazeHistory.shift();

    // คำนวณ variance ความคลาดเคลื่อนตำแหน่ง gaze
    const meanX = gazeHistory.reduce((sum, p) => sum + p.x, 0) / gazeHistory.length;
    const meanY = gazeHistory.reduce((sum, p) => sum + p.y, 0) / gazeHistory.length;
    const variance = gazeHistory.reduce((sum, p) => sum + ((p.x - meanX)**2 + (p.y - meanY)**2), 0) / gazeHistory.length;

    if (variance < FIXATION_VARIANCE_THRESHOLD) {
      // โฟกัส
      if (!isFixating) {
        fixationStartTime = performance.now();
        isFixating = true;
      } else {
        const elapsed = performance.now() - fixationStartTime;
        if (elapsed > FIXATION_TIME_THRESHOLD_MS) {
          // เก็บเวลาช่วงโฟกัส
          if (!focusSessions.length || focusSessions[focusSessions.length -1].ended) {
            focusSessions.push({ started: fixationStartTime, ended: null, duration: 0 });
          }
          let currentSession = focusSessions[focusSessions.length -1];
          currentSession.duration = elapsed;
          accumulatedFocusTime += elapsed;

          // อัพเดต fixationStartTime เพื่อวัดต่อเนื่อง
          fixationStartTime = performance.now();

          // อัพเดต UI
          updateUI(currentSession.duration);
        }
      }
    } else {
      // ไม่โฟกัส
      if (isFixating) {
        // จบ session
        let currentSession = focusSessions[focusSessions.length -1];
        if (currentSession && !currentSession.ended) {
          currentSession.ended = performance.now();
        }
      }
      isFixating = false;
      fixationStartTime = null;
    }
  }

  function updateUI(currentDuration) {
    statusText.innerText = `Focusing... Session: ${Math.round(currentDuration)} ms\nTotal Focus: ${Math.round(accumulatedFocusTime)} ms`;
    // แสดง log session ล่าสุด
    logDiv.innerHTML = '<b>Focus sessions (ms):</b><br>';
    focusSessions.forEach((session, i) => {
      const dur = Math.round(session.duration || 0);
      logDiv.innerHTML += `Session ${i+1}: ${dur} ms<br>`;
    });
  }

  // MediaPipe FaceMesh setup
  const faceMesh = new FaceMesh({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
  });

  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  faceMesh.onResults(onResults);

  // เริ่มกล้อง
  const camera = new Camera(videoElement, {
    onFrame: async () => {
      await faceMesh.send({image: videoElement});
    },
    width: 640,
    height: 480
  });
  camera.start();

  // process results
  function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
      const landmarks = results.multiFaceLandmarks[0];

      const leftEye = LEFT_EYE_INDICES.map(i => landmarks[i]);
      const rightEye = RIGHT_EYE_INDICES.map(i => landmarks[i]);

      const leftEAR = calculateEAR(leftEye);
      const rightEAR = calculateEAR(rightEye);
      const ear = (leftEAR + rightEAR) / 2;

      // คำนวณตำแหน่ง gaze คร่าวๆ (center จุดตา)
      const gazeX = (leftEye[0].x + leftEye[3].x + rightEye[0].x + rightEye[3].x) / 4;
      const gazeY = (leftEye[0].y + leftEye[3].y + rightEye[0].y + rightEye[3].y) / 4;

      updateGazePosition({x: gazeX, y: gazeY});

      // วาดจุด landmark ตา
      for (const point of leftEye.concat(rightEye)) {
        canvasCtx.beginPath();
        canvasCtx.arc(point.x * canvasElement.width, point.y * canvasElement.height, 4, 0, 2 * Math.PI);
        canvasCtx.fillStyle = "blue";
        canvasCtx.fill();
      }

      // แสดง EAR บนหน้าจอ
      canvasCtx.font = "20px Arial";
      canvasCtx.fillStyle = "red";
      canvasCtx.fillText(`EAR: ${ear.toFixed(3)}`, 10, 460);
    } else {
      statusText.innerText = "No face detected";
    }

    canvasCtx.restore();
  }
</script>
</body>
</html>
